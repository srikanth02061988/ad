-- Query to aggregate token usage by sessionId and traceDate
WITH token_usage AS (
    SELECT 
        sessionId, 
        to_date(traceTime) as traceDate,
        CAST(trace.value AS FLOAT) AS tokens
    FROM 
        hive_metastore.default.rai_new_payload_v2
    WHERE 
        traceType = 'metric' 
        AND trace.attribute = 'tokenCount'
)
SELECT 
    sessionId,
    traceDate,
    SUM(tokens) AS total_tokens
FROM 
    token_usage
GROUP BY 
    sessionId, traceDate
ORDER BY 
    traceDate, sessionId;
