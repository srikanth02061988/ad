-- Main SQL query with both jailbreakAttempt and guardrailAttempt, handling null values
WITH attempts AS (
    SELECT 
        sessionId, 
        traceTime,
        attribute,
        CAST(trace.value AS FLOAT) AS value
    FROM 
        hive_metastore.default.rai_new_payload_v2
    WHERE 
        traceType = 'metric' 
        AND (trace.attribute = 'jailbreakAttempt' OR trace.attribute = 'guardrailAttempt')
)
SELECT 
    sessionId,
    traceTime,
    MAX(CASE WHEN attribute = 'jailbreakAttempt' THEN value ELSE 0 END) AS jailbreak,
    MAX(CASE WHEN attribute = 'guardrailAttempt' THEN value ELSE 0 END) AS guardrail
FROM 
    attempts
GROUP BY 
    sessionId, traceTime;
