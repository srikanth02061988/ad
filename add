import org.junit.jupiter.api.*;
import org.mockito.*;
import static org.mockito.Mockito.*;
import java.net.http.HttpResponse;
import java.net.http.HttpClient;
import java.net.URI;
import org.json.JSONObject;

class BlobStorageTriggerFunctionTest {

    // Internal wrapper class within the test
    private static class DatabricksUtilWrapper {
        public HttpResponse<String> postRequest(URI uri, JSONObject payload) throws Exception {
            return DatabricksUtil.getHttpClient(false).send(
                DatabricksUtil.createPostRequest(uri, payload),
                HttpResponse.BodyHandlers.ofString()
            );
        }
    }

    @Test
    void testTriggerDBJob() throws Exception {
        // Arrange
        DatabricksUtilWrapper wrapper = Mockito.mock(DatabricksUtilWrapper.class);
        HttpResponse<String> mockedResponse = Mockito.mock(HttpResponse.class);

        // Prepare the mocked response
        when(mockedResponse.body()).thenReturn("{\"run_id\": \"12345\"}");
        when(mockedResponse.statusCode()).thenReturn(200);

        // Mock the wrapper's postRequest method
        when(wrapper.postRequest(any(URI.class), any(JSONObject.class)))
            .thenReturn(mockedResponse);

        // Initialize the function with the mocked wrapper
        BlobStorageTriggerFunction function = new BlobStorageTriggerFunction(wrapper);

        // Act
        String result = function.triggerDBJob(new HashMap<>(), new JSONObject());

        // Assert
        Assertions.assertEquals("12345", result);

        // Verify that the wrapper's postRequest method was called
        verify(wrapper).postRequest(any(URI.class), any(JSONObject.class));
    }
}
